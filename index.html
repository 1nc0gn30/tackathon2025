<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1990s Tacky Christmas Portal ‚Äî Hackathon 2025</title>
  <style>
    /* === GLOBAL + EFFECTS === */
    :root {
      --glow-green: #2fff7f;
      --glow-red: #ff2f6d;
      --panel: rgba(10, 10, 10, 0.8);
      --scanlines: repeating-linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.05) 0px,
        rgba(255, 255, 255, 0.05) 2px,
        rgba(0, 0, 0, 0) 4px
      );
      --accent: #39ff14;
      --active-accent: #39ff14;
      --crt-curve: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.08) 35%, rgba(0, 0, 0, 0.12) 80%);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Comic Sans MS", "Courier New", cursive;
      background: radial-gradient(circle at 20% 20%, #062b0f, #050505 55%),
        radial-gradient(circle at 80% 10%, #0c1b3f, #050505 60%),
        repeating-linear-gradient(45deg, #0b3e1d 0, #0b3e1d 10px, #0f0f0f 10px, #0f0f0f 20px);
      color: var(--glow-green);
      min-height: 100vh;
      padding: clamp(10px, 3vw, 24px);
      overflow-x: hidden;
      position: relative;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: var(--scanlines);
      mix-blend-mode: overlay;
      opacity: 0.5;
    }

    .crt-shell {
      position: relative;
      isolation: isolate;
    }

    .crt-shell::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: var(--crt-curve);
      mix-blend-mode: screen;
      opacity: 0.8;
      z-index: 10;
      border-radius: 2vw;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
    }

    /* === HEADER === */
    header {
      text-align: center;
      padding: 10px 0 2px;
      color: var(--glow-red);
      text-shadow: 0 0 8px var(--glow-red);
      letter-spacing: 4px;
      font-size: 1.6rem;
      animation: flicker 2s infinite;
    }

    marquee {
      color: #ffe900;
      text-shadow: 0 0 10px #ffe900;
      font-size: 1rem;
      margin: 6px 0 14px;
    }

    @keyframes flicker {
      0%,
      100% { opacity: 1; }
      88% { opacity: 0.6; }
      94% { opacity: 0.2; }
    }

    /* === LAYOUT === */
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: clamp(12px, 2vw, 18px);
      align-items: stretch;
    }

    .panel {
      position: relative;
      background: var(--panel);
      border: 3px ridge #39ff14;
      border-radius: 14px;
      box-shadow: 0 0 20px #39ff1480, inset 0 0 12px #ff2f6d60;
      padding: 18px;
      overflow: hidden;
    }

    .panel h2 {
      margin: 0 0 6px;
      color: #fff;
      text-shadow: 0 0 6px #fff;
      letter-spacing: 1px;
    }

    .panel p {
      margin: 6px 0 12px;
      color: #d2ffd2;
    }

    /* === TREE ZONE === */
    .tree-wrap {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
    }

    .lights {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-bottom: 6px;
    }

    .bulb {
      width: 22px;
      height: 34px;
      border-radius: 50% 50% 46% 46%;
      background: red;
      animation: blink 1s infinite alternate;
      box-shadow: 0 0 14px red;
      border: 2px solid #240000;
    }

    .bulb:nth-child(2) { background: lime; animation-duration: 1.3s; box-shadow: 0 0 14px lime; }
    .bulb:nth-child(3) { background: gold; animation-duration: 0.8s; box-shadow: 0 0 14px gold; }
    .bulb:nth-child(4) { background: cyan; animation-duration: 1.6s; box-shadow: 0 0 14px cyan; }
    .bulb:nth-child(5) { background: magenta; animation-duration: 1.1s; box-shadow: 0 0 14px magenta; }

    @keyframes blink {
      from { opacity: 0.3; transform: translateY(0); }
      to { opacity: 1; transform: translateY(-3px); }
    }

    .tree-space {
      position: relative;
      min-height: clamp(360px, 60vw, 520px);
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 50% 30%, #0f5c2a, #093016 62%, #010a05 85%);
      border: 2px dashed #ffe90066;
      border-radius: 12px;
      box-shadow: inset 0 0 20px #01220f;
      overflow: hidden;
      perspective: 800px;
    }

    .tree-space::before,
    .tree-space::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      transition: transform 0.3s ease;
    }

    .tree-space::before {
      background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.05), transparent 40%),
        radial-gradient(circle at 70% 40%, rgba(255, 233, 0, 0.08), transparent 55%);
      transform: translate3d(0, 0, 0);
    }

    .tree-space::after {
      background: radial-gradient(circle, rgba(57, 255, 20, 0.08), transparent 60%);
      mix-blend-mode: screen;
    }

    .tree-space.parallax-tilt::before { transform: translate3d(var(--tilt-x, 0), var(--tilt-y, 0), 0); }
    .tree-space.parallax-tilt::after { transform: translate3d(calc(var(--tilt-x, 0) * -1), calc(var(--tilt-y, 0) * -1), 0); }

    .tree-space::after:hover { opacity: 0.3; }

    .tree-space::marker { display: none; }

    .tree-space:focus-within::after { box-shadow: 0 0 26px var(--accent); opacity: 0.3; }

    .tree {
      position: relative;
      width: clamp(220px, 42vw, 320px);
      height: clamp(320px, 58vw, 430px);
      filter: drop-shadow(0 0 12px #39ff14);
      isolation: isolate;
      transform-style: preserve-3d;
      transition: transform 0.3s ease;
    }

    .tree::before,
    .tree::after {
      content: "";
      position: absolute;
      inset: 8% 6%;
      border-radius: 50%;
      border: 4px dotted rgba(255, 233, 0, 0.5);
      animation: pulse 4s infinite ease-in-out;
      pointer-events: none;
      filter: drop-shadow(0 0 6px #ffe90088);
    }

    .tree::after {
      inset: 14% 10%;
      border: 3px dashed rgba(255, 255, 255, 0.3);
      animation-duration: 6s;
    }

    .tree .layer {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 40%;
      background: linear-gradient(135deg, #0c8c3d, #0d5e2c 60%, #0c8c3d);
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      border: 3px solid #073a1a;
      box-shadow: inset 0 0 12px #1aff7f66;
    }

    .layer:nth-child(1) { top: 10%; width: 60%; height: 32%; }
    .layer:nth-child(2) { top: 32%; width: 74%; height: 34%; }
    .layer:nth-child(3) { top: 56%; width: 90%; height: 40%; }

    .tree .trunk {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 70px;
      background: linear-gradient(90deg, #6b3f1f, #4a260f);
      border: 3px solid #2a1608;
      border-radius: 8px;
      box-shadow: 0 0 12px #2a160880;
    }

    .tree .star {
      position: absolute;
      top: -14px;
      left: 50%;
      transform: translateX(-50%) rotate(8deg);
      font-size: 36px;
      filter: drop-shadow(0 0 8px #ffe900);
      animation: twinkle 1.5s infinite;
    }

    @keyframes twinkle {
      0%,
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
      50% { transform: translateX(-50%) scale(1.1); opacity: 0.6; }
    }

    @keyframes pulse {
      0%,
      100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.04); }
    }

    /* === ORNAMENTS === */
    .ornament {
      position: absolute;
      width: clamp(56px, 10vw, 76px);
      height: clamp(56px, 10vw, 76px);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 32px;
      color: #111;
      border: 3px solid #ffe900;
      cursor: pointer;
      box-shadow: 0 0 16px #ffe90088, inset 0 0 10px #fff, 0 0 30px rgba(255, 255, 255, 0.2);
      transition: transform 0.2s, filter 0.2s, box-shadow 0.2s;
      outline: none;
    }

    .ornament:hover,
    .ornament:focus-visible { transform: scale(1.1) rotate(-4deg); filter: saturate(1.3); box-shadow: 0 0 20px #ffe900; }
    .ornament.active { outline: 4px double #ff2f6d; transform: scale(1.15); box-shadow: 0 0 30px #ff2f6d; }

    .ornament[data-id="snow"] { background: linear-gradient(135deg, #fff, #c7f8ff); top: 30%; left: 48%; }
    .ornament[data-id="react"] { background: linear-gradient(135deg, #ff8bf0, #ff2f6d); top: 50%; left: 34%; }
    .ornament[data-id="hunt"] { background: linear-gradient(135deg, #88f57b, #39ff14); top: 54%; left: 64%; }
    .ornament[data-id="jukebox"] { background: linear-gradient(135deg, #ffd480, #ffb347); top: 70%; left: 46%; }

    .glow-base {
      position: absolute;
      inset: auto 8% -14px;
      height: 18px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(57, 255, 20, 0.6), transparent 70%);
      filter: blur(6px);
      opacity: 0.8;
      pointer-events: none;
    }

    /* === GAME PANEL SHARED === */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #120021;
      border: 2px solid var(--active-accent);
      border-radius: 8px;
      color: #ffd6ff;
      box-shadow: 0 0 12px var(--active-accent);
      margin-bottom: 10px;
    }

    .status .pill {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.85rem;
    }

    button.action,
    .action.button-like {
      background: var(--glow-red);
      border: 2px solid #ff9fb9;
      color: #fff;
      font-weight: bold;
      padding: 12px 18px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 12px var(--glow-red);
      text-shadow: 0 0 6px #000;
      transition: transform 0.15s ease;
      min-width: 130px;
      font-size: 1rem;
    }

    button.action:hover,
    .action.button-like:hover { transform: translateY(-2px) scale(1.05); }
    button.action:focus-visible { outline: 3px solid #ffe900; }

    .game-area {
      margin-top: 12px;
      padding: 14px;
      border: 2px dashed #39ff1488;
      border-radius: 12px;
      background: radial-gradient(circle, #0f1625, #050915 65%);
      min-height: 180px;
      color: #e4ffe4;
      position: relative;
      display: grid;
      gap: 10px;
    }

    .control-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-row label {
      color: #e4ffe4;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    select,
    .dropdown {
      background: #0a1224;
      color: #e4ffe4;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 6px 8px;
      border-radius: 6px;
      min-height: 36px;
    }

    .mono { font-family: "Courier New", monospace; }

    /* === SNOW CONSOLE === */
    .snow-console {
      background: #010c18;
      color: #aee7ff;
      padding: 12px;
      min-height: 140px;
      border-radius: 8px;
      border: 2px solid #13c2ff;
      box-shadow: inset 0 0 12px #13c2ff55;
      white-space: pre-wrap;
      line-height: 1.2;
      max-height: 220px;
      overflow: auto;
    }

    /* === REACTION LAB === */
    .reaction-lamp {
      width: clamp(110px, 18vw, 170px);
      height: clamp(110px, 18vw, 170px);
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: #000;
      font-weight: bold;
      margin: 10px auto;
      border: 6px solid #fff;
      box-shadow: 0 0 20px currentColor, 0 0 50px rgba(255, 255, 255, 0.4);
      transition: background 0.2s, color 0.2s;
    }

    /* === PRESENT HUNT === */
    .hunt-field {
      position: relative;
      height: 240px;
      border: 2px dotted #ffe900;
      margin-top: 10px;
      overflow: hidden;
      background: linear-gradient(180deg, #083b1a, #03170b);
      box-shadow: inset 0 0 14px #000;
      border-radius: 12px;
    }

    .present {
      position: absolute;
      font-size: 30px;
      cursor: pointer;
      transition: transform 0.1s;
      text-shadow: 0 0 8px #ff2f6d;
    }

    .present:hover,
    .present:focus-visible { transform: scale(1.3) rotate(-6deg); outline: 2px solid #ffe900; border-radius: 6px; }

    /* === JUKEBOX === */
    .jukebox { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

    .tracklist { display: grid; gap: 10px; margin-top: 8px; }

    .track-card {
      border: 2px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(17, 5, 29, 0.8);
      box-shadow: 0 0 10px rgba(255, 179, 71, 0.28);
      display: grid;
      gap: 4px;
    }

    .track-card h4 { margin: 0; color: #ffe9c2; }
    .track-meta { color: #f8e1ff; font-size: 0.9rem; }

    .track-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .track-actions a { color: #ffe900; font-weight: bold; text-decoration: none; }

    .player-frame {
      border: 2px solid #ffb347;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 16px rgba(255, 179, 71, 0.4);
      aspect-ratio: 16 / 9;
      background: #0f0700;
    }

    .jukebox-preview {
      height: 90px;
      border-radius: 10px;
      border: 2px solid #ffb347;
      box-shadow: inset 0 0 12px #ffb34766;
    }

    .ticker {
      display: block;
      font-size: 0.9rem;
      color: #ffe900;
      text-shadow: 0 0 8px #ffe900;
      margin-top: 8px;
    }

    /* === MISC === */
    footer {
      margin-top: 20px;
      text-align: center;
      color: #8cd88c;
      font-size: 0.8rem;
    }

    .snowfall-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 9;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .snowflake {
      position: absolute;
      color: #fff;
      font-size: 14px;
      text-shadow: 0 0 8px #fff;
      animation: fall linear;
    }

    @keyframes fall {
      to { transform: translateY(110vh); opacity: 0.4; }
    }

    .ultimate-1997 {
      background: repeating-linear-gradient(90deg, #0b3e1d, #0b3e1d 10px, #001133 10px, #001133 20px),
        radial-gradient(circle at 20% 20%, #ff00c8, #000 55%), radial-gradient(circle at 80% 10%, #00ffcc, #000 60%);
      color: #ffe900;
    }

    .tool-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }

    /* === RESPONSIVE === */
    @media (max-width: 940px) {
      .grid { grid-template-columns: 1fr; }
      .tree-space { min-height: 360px; }
      .tree::before, .tree::after { display: none; }
    }

    @media (max-width: 620px) {
      header { font-size: 1.2rem; }
      marquee { font-size: 0.9rem; }
      .panel { padding: 14px; }
      .tree-space { padding: 10px; }
      .ornament { font-size: 1.8rem; min-width: 64px; min-height: 64px; }
      .ornament[data-id="snow"] { top: 28%; left: 46%; }
      .ornament[data-id="react"] { top: 48%; left: 32%; }
      .ornament[data-id="hunt"] { top: 52%; left: 68%; }
      .ornament[data-id="jukebox"] { top: 70%; left: 46%; }
      .status { flex-wrap: wrap; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
</head>
<body class="crt-shell">
  <header>üå≤ TACKY CHRISTMAS PORTAL ‚Äî 1990s EDITION üå≤</header>
  <marquee scrollamount="8" aria-label="Holiday news ticker">WELCOME TO THE HACKATHON NORTH POLE NETZONE ‚Ä¢ DOUBLE-CLICK EVERYTHING ‚Ä¢ EAT VIRTUAL COOKIES ‚Ä¢ WIN VIRTUAL GLORY</marquee>

  <div class="tool-row">
    <button class="action" id="postcardBtn" aria-label="Download postcard screenshot">üì∏ Screenshot Postcard</button>
    <span class="pill ticker">Tip: ornaments work with keyboard too. Secret code? Maybe try classic Konami.</span>
  </div>

  <div class="grid">
    <div class="tree-wrap panel">
      <div class="lights" aria-hidden="true">
        <div class="bulb"></div>
        <div class="bulb"></div>
        <div class="bulb"></div>
        <div class="bulb"></div>
        <div class="bulb"></div>
      </div>
      <div class="tree-space parallax-tilt" aria-label="Tree zone with ornaments" tabindex="-1">
        <div class="tree" aria-label="Retro Christmas Tree">
          <div class="star" aria-hidden="true">‚ú∏</div>
          <div class="layer"></div>
          <div class="layer"></div>
          <div class="layer"></div>
          <div class="trunk" aria-hidden="true"></div>
          <div class="glow-base" aria-hidden="true"></div>
          <button class="ornament" data-id="snow" aria-label="Open Snow Console">‚ùÑÔ∏è</button>
          <button class="ornament" data-id="react" aria-label="Open Elf Reaction Lab">üéÑ</button>
          <button class="ornament" data-id="hunt" aria-label="Open Present Hunt">üéÅ</button>
          <button class="ornament" data-id="jukebox" aria-label="Open Jingle Jukebox">üé∂</button>
        </div>
      </div>
    </div>

    <div class="panel" id="gamePanel">
      <h2 aria-live="polite">üéÆ Elf Arcade Hub</h2>
      <p>Choose an ornament to beam a mini-game into this glowing panel. Everything is tacky on purpose.</p>
      <div class="game-area" id="gameArea" aria-live="polite"></div>
    </div>
  </div>

  <footer>Crafted with 1990s joy &amp; neon ‚Äî Hackathon 2025</footer>
  <div class="snowfall-layer" id="snowfallLayer" aria-hidden="true"></div>

  <script>
    /* === DOM CACHE & HELPERS === */
    const dom = {
      body: document.body,
      root: document.documentElement,
      ornaments: Array.from(document.querySelectorAll('.ornament')),
      gameArea: document.getElementById('gameArea'),
      gamePanel: document.getElementById('gamePanel'),
      postcardBtn: document.getElementById('postcardBtn'),
      snowfallLayer: document.getElementById('snowfallLayer'),
      treeSpace: document.querySelector('.tree-space'),
      tree: document.querySelector('.tree'),
    };

    const state = {
      activeInterval: null,
      activeTimeout: null,
      bestReaction: null,
      snowTicker: [],
      konamiBuffer: [],
      parallaxFrame: null,
    };

    const cleanupTimers = () => {
      if (state.activeInterval) {
        clearInterval(state.activeInterval);
        state.activeInterval = null;
      }
      if (state.activeTimeout) {
        clearTimeout(state.activeTimeout);
        state.activeTimeout = null;
      }
    };

    const setAccent = (color) => {
      dom.root.style.setProperty('--active-accent', color);
    };

    /* === ACCESSIBILITY: ORNAMENT NAVIGATION === */
    dom.ornaments.forEach((ornament) => {
      ornament.setAttribute('role', 'button');
      ornament.tabIndex = 0;
      ornament.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          ornament.click();
        }
      });
    });

    /* === SNOW CONSOLE CONTROLLER === */
    const SnowConsole = (() => {
      let logEl;

      const addLog = (message) => {
        if (!logEl) return;
        state.snowTicker.push(message);
        if (state.snowTicker.length > 12) state.snowTicker.shift();
        logEl.textContent = state.snowTicker.join('\n');
      };

      const startStream = () => {
        cleanupTimers();
        addLog('‚öôÔ∏è Generating crystal snowflakes...');
        let count = 0;
        state.activeInterval = setInterval(() => {
          const flake = '*'.repeat(2 + Math.floor(Math.random() * 6));
          addLog(`‚ùÑÔ∏è ${flake} drift ${++count}`);
          if (count % 6 === 0) addLog('üéÖ Santa: more snow!');
        }, 450);
      };

      const render = () => {
        dom.gameArea.innerHTML = `
          <div class="status" aria-label="Snow console status">
            <span aria-hidden="true">‚ùÑÔ∏è</span><strong>Snow Console</strong>
            <span class="pill">Text-mode forecast</span>
          </div>
          <div class="control-row">
            <button class="action" id="snowPrint">PRINT SNOW</button>
            <button class="action" id="snowStop">CLEAR</button>
          </div>
          <div class="snow-console mono" id="snowLog" role="log" aria-live="polite"></div>
        `;
        logEl = document.getElementById('snowLog');
        addLog('Console booted. Brrr.');

        const startBtn = document.getElementById('snowPrint');
        const stopBtn = document.getElementById('snowStop');

        startBtn.addEventListener('click', startStream);
        stopBtn.addEventListener('click', () => {
          cleanupTimers();
          state.snowTicker = [];
          addLog('Console cleared.');
        });
      };

      return { render };
    })();

    /* === REACTION LAB CONTROLLER === */
    const ReactionLab = (() => {
      let lamp, log, bestEl, ready = false, startTime = 0;

      const resetBest = () => {
        state.bestReaction = null;
        bestEl.textContent = 'Best: --';
        log.textContent = 'Prep your clicking finger...';
      };

      const armLasers = () => {
        cleanupTimers();
        lamp.textContent = 'WAIT';
        lamp.style.background = '#440044';
        lamp.style.color = '#ffe9ff';
        log.textContent = 'Holding...';
        ready = false;

        state.activeTimeout = setTimeout(() => {
          ready = true;
          lamp.textContent = 'GO!';
          lamp.style.background = '#00ff88';
          lamp.style.color = '#002b10';
          startTime = performance.now();
        }, 1200 + Math.random() * 1800);
      };

      const handleTap = () => {
        if (!ready) {
          log.textContent = 'Too early! The elves giggle.';
          return;
        }
        const ms = Math.round(performance.now() - startTime);
        const mood = ms < 250 ? 'üéÅ Lightning Elf!' : ms < 400 ? 'üåü Solid!' : 'üò¥ Sleepy Santa...';
        log.textContent = `Reaction: ${ms}ms ‚Äî ${mood}`;
        lamp.textContent = `${ms}ms`;
        if (!state.bestReaction || ms < state.bestReaction) {
          state.bestReaction = ms;
          bestEl.textContent = `Best: ${ms}ms`;
        }
        ready = false;
      };

      const render = () => {
        dom.gameArea.innerHTML = `
          <div class="status" aria-label="Reaction lab status">
            <span aria-hidden="true">üéÑ</span><strong>Elf Reaction Lab</strong>
            <span class="pill" id="reactBest">Best: --</span>
          </div>
          <div class="reaction-lamp" id="lamp" role="button" aria-label="Reaction lamp">READY?</div>
          <div class="control-row">
            <button class="action" id="reactBtn">ARM THE LASERS</button>
            <button class="action" id="reactReset">RESET BEST</button>
          </div>
          <div class="mono" id="reactLog">Prep your clicking finger...</div>
        `;

        lamp = document.getElementById('lamp');
        const btn = document.getElementById('reactBtn');
        const reset = document.getElementById('reactReset');
        log = document.getElementById('reactLog');
        bestEl = document.getElementById('reactBest');

        bestEl.textContent = `Best: ${state.bestReaction ? state.bestReaction + 'ms' : '--'}`;
        btn.addEventListener('click', armLasers);
        reset.addEventListener('click', resetBest);
        lamp.addEventListener('click', handleTap);
        lamp.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleTap();
          }
        });
        lamp.tabIndex = 0;
      };

      return { render };
    })();

    /* === PRESENT HUNT CONTROLLER === */
    const PresentHunt = (() => {
      const presents = ['üéÅ', 'üéÄ', 'üß¶', 'üß∏', 'üç¨', 'üç≠', 'üé´'];
      let field, log, timerEl, difficulty;

      const handleGiftClick = (gift, total, found, start) => {
        gift.remove();
        const elapsed = Math.round(performance.now() - start);
        log.textContent = `Collected ${found + 1}/${total} in ${elapsed}ms`;
      };

      const spawnRun = () => {
        field.innerHTML = '';
        cleanupTimers();
        let found = 0;
        const mode = difficulty.value;
        const timeLimit = mode === 'easy' ? 8000 : mode === 'hard' ? 12000 : 10000;
        const total = mode === 'hard' ? 12 : 6 + Math.floor(Math.random() * 4);
        const start = performance.now();
        timerEl.textContent = `Timer: ${(timeLimit / 1000).toFixed(0)}s`;

        for (let i = 0; i < total; i++) {
          const gift = document.createElement('span');
          gift.textContent = presents[Math.floor(Math.random() * presents.length)];
          gift.className = 'present';
          gift.tabIndex = 0;
          gift.style.left = Math.random() * 88 + '%';
          gift.style.top = Math.random() * 82 + '%';
          gift.setAttribute('role', 'button');
          gift.setAttribute('aria-label', `Gift ${i + 1} of ${total}`);
          const handleCollect = () => {
            handleGiftClick(gift, total, found, start);
            found++;
            if (found === total) {
              const elapsed = Math.round(performance.now() - start);
              log.textContent = `ALL PRESENTS SECURED in ${elapsed}ms ‚Äî SLEIGH DEPLOYED!`;
              timerEl.textContent = 'Timer: cleared!';
              cleanupTimers();
            }
          };
          gift.addEventListener('click', handleCollect);
          gift.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleCollect();
            }
          });
          field.appendChild(gift);
        }

        // Timer logic: updates countdown, clears when done
        state.activeInterval = setInterval(() => {
          const remaining = Math.max(0, timeLimit - (performance.now() - start));
          timerEl.textContent = `Timer: ${(remaining / 1000).toFixed(1)}s`;
          if (remaining <= 0) {
            clearInterval(state.activeInterval);
            state.activeInterval = null;
            if (field.children.length > 0) {
              log.textContent = "Time's up! The sleigh zoomed away.";
              field.innerHTML = '';
            }
          }
        }, 120);

        state.activeTimeout = setTimeout(() => {
          if (field.children.length > 0) {
            log.textContent = "Time's up! The sleigh zoomed away.";
            field.innerHTML = '';
          }
        }, timeLimit);
      };

      const render = () => {
        dom.gameArea.innerHTML = `
          <div class="status" aria-label="Present hunt status">
            <span aria-hidden="true">üéÅ</span><strong>Present Radar</strong>
            <span class="pill" id="huntTimer">Timer: --</span>
          </div>
          <div class="control-row">
            <label for="huntDifficulty">Difficulty
              <select id="huntDifficulty" aria-label="Choose difficulty">
                <option value="easy">Easy (8s)</option>
                <option value="medium" selected>Medium (10s)</option>
                <option value="hard">Hard (12 gifts, 12s)</option>
              </select>
            </label>
            <button class="action" id="spawnBtn">SPAWN PRESENTS</button>
          </div>
          <div class="mono" id="huntLog">Click all the presents before they despawn.</div>
          <div class="hunt-field" id="huntField" role="region" aria-label="Present hunt field"></div>
        `;

        field = document.getElementById('huntField');
        log = document.getElementById('huntLog');
        const btn = document.getElementById('spawnBtn');
        timerEl = document.getElementById('huntTimer');
        difficulty = document.getElementById('huntDifficulty');

        btn.addEventListener('click', spawnRun);
      };

      return { render };
    })();

    /* === JUKEBOX CONTROLLER === */
    const Jukebox = (() => {
      const vibes = [
        { name: 'Candy Cane', bg: 'repeating-linear-gradient(45deg, #ff2f6d 0, #ff2f6d 14px, #ffffff 14px, #ffffff 28px)', note: 'Classic stripes for maximal sugar rush' },
        { name: 'Aurora', bg: 'radial-gradient(circle at 20% 30%, #00ffcc, transparent 35%), radial-gradient(circle at 80% 40%, #ff00f7, transparent 40%), #01000c', note: 'Northern lights straight from MS Paint' },
        { name: 'CRT Grid', bg: 'linear-gradient(0deg, #0f0f0f 0, #0f0f0f 92%, #39ff14 92%), linear-gradient(90deg, #0f0f0f 0, #0f0f0f 92%, #39ff14 92%)', note: 'Green-on-black motherboard chic' },
        { name: 'Gingerbread', bg: 'repeating-linear-gradient(0deg, #6b3f1f 0, #6b3f1f 20px, #3b1f0c 20px, #3b1f0c 36px)', note: 'Warm cookie plaid goodness' },
      ];

      const tracks = [
        { title: 'All I Want for Christmas Is You', artist: 'Mariah Carey', year: 1994, note: 'The supreme 90s mall anthem.', youtube: 'https://www.youtube.com/watch?v=yXQViqx6GMY', embed: 'https://www.youtube.com/embed/yXQViqx6GMY?autoplay=1' },
        { title: 'Merry Christmas, Happy Holidays', artist: '*NSYNC', year: 1998, note: 'Boy band harmonies meet snow machines.', youtube: 'https://www.youtube.com/watch?v=wKj92352UAE', embed: 'https://www.youtube.com/embed/wKj92352UAE?autoplay=1' },
        { title: 'Sleigh Ride', artist: 'TLC', year: 1993, note: 'R&B sleigh bells with peak 90s swagger.', youtube: 'https://www.youtube.com/watch?v=ke2Gcp46rHU', embed: 'https://www.youtube.com/embed/ke2Gcp46rHU?autoplay=1' },
        { title: 'Christmas Wrapping', artist: 'Spice Girls', year: 1998, note: 'Girl power, holiday edition.', youtube: 'https://www.youtube.com/watch?v=R-KBuSgWFEI', embed: 'https://www.youtube.com/embed/R-KBuSgWFEI?autoplay=1' },
        { title: 'This Christmas', artist: '98 Degrees', year: 1999, note: 'Boy-band slow jam for cocoa mode.', youtube: 'https://www.youtube.com/watch?v=0rYzcn7_h3s', embed: 'https://www.youtube.com/embed/0rYzcn7_h3s?autoplay=1' },
      ];

      const render = () => {
        dom.gameArea.innerHTML = `
          <div class="status" aria-label="Jukebox status">
            <span aria-hidden="true">üé∂</span><strong>Jingle Jukebox</strong>
          </div>
          <p>Pick a vibe and the whole background morphs like a GIF from 1997. Now featuring real 90s holiday bops via YouTube embeds!</p>
          <div class="control-row">
            <button class="action" id="shuffleJukebox">SHUFFLE VIBE</button>
            <span class="pill">Changes also tint the tree lights ‚ú®</span>
          </div>
          <div class="jukebox-preview" id="jukeboxPreview" aria-label="Background preview"></div>
          <div class="jukebox" id="jukeboxGrid"></div>
          <div class="tracklist" id="trackList"></div>
          <div class="player-frame" id="playerFrame"></div>
          <div class="mono" id="jukeboxLog">Pro tip: stack vibes for maximum chaos.</div>
        `;

        const grid = document.getElementById('jukeboxGrid');
        const log = document.getElementById('jukeboxLog');
        const shuffle = document.getElementById('shuffleJukebox');
        const preview = document.getElementById('jukeboxPreview');
        const trackList = document.getElementById('trackList');
        const playerFrame = document.getElementById('playerFrame');

        preview.style.background = dom.body.style.background || vibes[0].bg;

        vibes.forEach((vibe) => {
          const card = document.createElement('button');
          card.className = 'action button-like';
          card.style.background = 'var(--active-accent)';
          card.style.color = '#120021';
          card.innerHTML = `<strong>${vibe.name}</strong><br><small>${vibe.note}</small>`;
          card.addEventListener('click', () => {
            dom.body.style.background = vibe.bg;
            preview.style.background = vibe.bg;
            log.textContent = `${vibe.name} engaged ‚Äî backgrounds like it's 1997!`;
          });
          grid.appendChild(card);
        });

        shuffle.addEventListener('click', () => {
          const vibe = vibes[Math.floor(Math.random() * vibes.length)];
          dom.body.style.background = vibe.bg;
          preview.style.background = vibe.bg;
          log.textContent = `${vibe.name} shuffle drop ‚Äî remixing the glow!`;
        });

        tracks.forEach((track) => {
          const card = document.createElement('div');
          card.className = 'track-card';
          card.innerHTML = `
            <h4>${track.title}</h4>
            <div class="track-meta">${track.artist} ‚Ä¢ ${track.year}</div>
            <div class="track-meta">${track.note}</div>
            <div class="track-actions">
              <button class="action" data-embed="${track.embed}">Play inline ‚ñ∂Ô∏è</button>
              <a href="${track.youtube}" target="_blank" rel="noopener">Open on YouTube ‚Üó</a>
            </div>
          `;

          card.querySelector('button').addEventListener('click', (e) => {
            const src = e.currentTarget.getAttribute('data-embed');
            playerFrame.innerHTML = `<iframe width="100%" height="100%" src="${src}" title="YouTube player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            log.textContent = `Now streaming: ${track.title} ‚Äî ${track.artist}`;
          });

          trackList.appendChild(card);
        });
      };

      return { render };
    })();

    /* === GAME SWITCHER === */
    const controllers = {
      snow: SnowConsole,
      react: ReactionLab,
      hunt: PresentHunt,
      jukebox: Jukebox,
    };

    const accentMap = {
      snow: '#13c2ff',
      react: '#ff8bf0',
      hunt: '#39ff14',
      jukebox: '#ffb347',
    };

    const activateGame = (id) => {
      cleanupTimers();
      dom.ornaments.forEach((o) => o.classList.toggle('active', o.dataset.id === id));
      const accent = accentMap[id] || '#39ff14';
      setAccent(accent);
      if (controllers[id]) controllers[id].render(accent);
    };

    dom.ornaments.forEach((ornament) => {
      ornament.addEventListener('click', () => activateGame(ornament.dataset.id));
    });

    /* === PARALLAX EFFECT === */
    const handleTilt = (event) => {
      if (state.parallaxFrame) cancelAnimationFrame(state.parallaxFrame);
      state.parallaxFrame = requestAnimationFrame(() => {
        const rect = dom.treeSpace.getBoundingClientRect();
        const x = ((event.clientX - rect.left) / rect.width - 0.5) * 10;
        const y = ((event.clientY - rect.top) / rect.height - 0.5) * 10;
        dom.treeSpace.style.setProperty('--tilt-x', `${x}px`);
        dom.treeSpace.style.setProperty('--tilt-y', `${y}px`);
        dom.tree.style.transform = `rotateX(${y / 3}deg) rotateY(${x / 3}deg)`;
      });
    };

    dom.treeSpace.addEventListener('pointermove', handleTilt);
    dom.treeSpace.addEventListener('pointerleave', () => {
      dom.treeSpace.style.removeProperty('--tilt-x');
      dom.treeSpace.style.removeProperty('--tilt-y');
      dom.tree.style.transform = 'none';
    });

    /* === KONAMI MODE === */
    const konamiSequence = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];

    const triggerKonami = () => {
      startSnowfall(true);
      dom.body.classList.add('ultimate-1997');
      playJingle();
      const originalBackground = dom.body.style.background;
      dom.body.dataset.konamiBg = originalBackground;
    };

    const playJingle = () => {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const now = ctx.currentTime;
      const notes = [523.25, 659.25, 783.99, 1046.5];
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = freq;
        osc.type = 'square';
        gain.gain.setValueAtTime(0.15, now + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.25);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now + i * 0.15);
        osc.stop(now + i * 0.15 + 0.3);
      });
    };

    window.addEventListener('keydown', (e) => {
      state.konamiBuffer.push(e.key);
      if (state.konamiBuffer.length > konamiSequence.length) state.konamiBuffer.shift();
      if (konamiSequence.every((key, idx) => state.konamiBuffer[idx] === key)) {
        triggerKonami();
      }
    });

    /* === SNOWFALL === */
    let snowInterval;
    const startSnowfall = (intense = false) => {
      dom.snowfallLayer.style.opacity = 1;
      const maxFlakes = intense ? 20 : 10;
      if (snowInterval) clearInterval(snowInterval);
      snowInterval = setInterval(() => {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.textContent = '‚úª';
        flake.style.left = Math.random() * 100 + '%';
        flake.style.animationDuration = 6 + Math.random() * 6 + 's';
        flake.style.fontSize = 12 + Math.random() * 10 + 'px';
        dom.snowfallLayer.appendChild(flake);
        setTimeout(() => flake.remove(), 12000);
      }, 600 / maxFlakes);
    };

    const stopSnowfall = () => {
      dom.snowfallLayer.style.opacity = 0;
      dom.snowfallLayer.innerHTML = '';
      if (snowInterval) clearInterval(snowInterval);
    };

    /* === SCREENSHOT POSTCARD === */
    dom.postcardBtn.addEventListener('click', async () => {
      const canvas = await html2canvas(document.body, { ignoreElements: (el) => el.id === 'postcardBtn' });
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tacky-christmas-postcard.png';
        a.click();
        URL.revokeObjectURL(url);
      });
    });

    /* === INITIALIZE === */
    activateGame('snow');
    startSnowfall();
  </script>
</body>
</html>
